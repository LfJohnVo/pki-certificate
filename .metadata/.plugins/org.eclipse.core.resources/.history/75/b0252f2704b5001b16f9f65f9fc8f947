package com.udemy.pki.core;

import java.io.ByteArrayOutputStream;
import java.io.InputStream;
import java.security.MessageDigest;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;

import com.itextpdf.text.Rectangle;
import com.itextpdf.text.pdf.PdfDate;
import com.itextpdf.text.pdf.PdfDictionary;
import com.itextpdf.text.pdf.PdfName;
import com.itextpdf.text.pdf.PdfPKCS7;
import com.itextpdf.text.pdf.PdfReader;
import com.itextpdf.text.pdf.PdfSignature;
import com.itextpdf.text.pdf.PdfSignatureAppearance;
import com.itextpdf.text.pdf.PdfStamper;
import com.itextpdf.text.pdf.PdfString;
import com.udemy.pki.bean.CertificadoUdemy;

public class PadesFirma {
	//byte es el pdf a firmar y certificado el certificado
	public static byte[] firmaPdfBasico(byte[] data, CertificadoUdemy certificado) throws Exception {
		
		try {
			
			PdfReader reader = new PdfReader(data);
			ByteArrayOutputStream nuevoDocumento = new ByteArrayOutputStream();
			//Se inicia para crear la firma digital dentro del pdf
			PdfStamper stp = PdfStamper.createSignature(reader, nuevoDocumento, '\000', null, true);
			PdfSignatureAppearance sap = stp.getSignatureAppearance();
			
			//este proceso genera la firma por defecto
			sap.setCrypto(certificado.getPrivateKey(), certificado.getCertificateChain(), null, PdfSignatureAppearance.WINCER_SIGNED);
			sap.setReason("Firma digital");
			sap.setLocation("Mexico");
			sap.setVisibleSignature(new Rectangle(100, 100, 350, 200), 1, "sig");
			stp.close();
			
			return nuevoDocumento.toByteArray();
			
		}catch (Exception e) {
			e.printStackTrace();
			
		}
		
		return null;
	}
	
	/*
	 * datadoc son los bits del documento
	 * Certificado es el certificado
	 * 
	 */
	public static byte[] firmarPdfAvanzado(byte[] dataDoc, CertificadoUdemy certificado) throws Exception {
		try {
			
			PdfReader reader = new PdfReader(data);
			ByteArrayOutputStream nuevoDocumento = new ByteArrayOutputStream();
			//Se inicia para crear la firma digital dentro del pdf
			PdfStamper stp = PdfStamper.createSignature(reader, nuevoDocumento, '\000', null, true);
			PdfSignatureAppearance sap = stp.getSignatureAppearance();
			//Se genera firma personalizada
			PdfSignature signature = new PdfSignature(PdfName.ADOBE_PPKLITE, new PdfName("adbe.pkcs7.detached"));
            signature.setReason("Firma Digital");
            signature.setLocation("Lima");
			
			
			
		} catch (Exception e) {
			e.printStackTrace();
			return null;
		}
	}
	
}
